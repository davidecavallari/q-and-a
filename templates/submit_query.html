{% extends "base.html" %}

{% block title %} Domanda {% endblock %}

{% block content %}
<div class="col-md-6 clearfix">
    <h4>Domande e risposte</h4>

    <!-- Loop through the conversation history and display it -->
    {% for entry in conversation_history %}
        <div class="card question-card mt-3 shadow"> 
            <div class="card-body">
                <h5>Domanda:</h5>
                <p>{{ entry.question }}</p>
            </div>
        </div>

        <!-- Clear floats -->
        <div class="clearfix"></div>
        
        <div class="card answer-card mt-3 shadow bg-answer"> 
            <div class="card-body">
                <h5>Risposta:</h5>
                <p>{{ entry.answer }}</p>
            </div>
        </div>
        
        <!-- Clear floats -->
        <div class="clearfix"></div>
    {% endfor %}

    <!-- Form to input a new question -->
    <div class="card mt-3 shadow">
        <div class="card-body">
            <form id="question-form" action="{{ url_for('submit_query') }}" method="post" class="d-flex">
                <input type="text" name="question" placeholder="Inserisci la tua domanda" class="form-control">
                <button type="submit" class="submit-button" disabled>
                    <i class="fa fa-arrow-right"></i>
                </button>
            </form>
        </div>
    </div>

     <!-- Button to clear the conversation history -->
     <div class="my-3 text-center">
        <form action="{{ url_for('clear_conversation') }}" method="post">
            <button type="submit" class="btn btn-danger">Ricomincia</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Seleziona l'elemento di input e il pulsante
        var inputElement = document.querySelector('input[name="question"]');
        var submitButton = document.querySelector('.submit-button');
    
        // Funzione di controllo dello stato del pulsante
        function checkButtonState() {
            if (inputElement.value.trim() !== '') {
                // Attiva il pulsante se la casella di testo contiene del testo
                submitButton.classList.add('active');
                submitButton.disabled = false; // Abilita il pulsante
            } else {
                // Disattiva il pulsante se la casella di testo Ã¨ vuota
                submitButton.classList.remove('active');
                submitButton.disabled = true; // Disabilita il pulsante
            }
        }
    
        // Controlla lo stato del pulsante quando la pagina viene caricata
        checkButtonState();
    
        // Aggiungi un listener per l'evento 'input' per controllare lo stato del pulsante ogni volta che il contenuto dell'input cambia
        inputElement.addEventListener('input', checkButtonState);
    });
</script>    

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Custom script to handle form submission -->
<script>
    $(document).ready(function() {
        $("#question-form").on("submit", function(event) {
            event.preventDefault();
            
            var question = $('input[name="question"]').val();
            
            $.ajax({
                type: "POST",
                url: "{{ url_for('submit_query') }}",
                data: {question: question},
                dataType: "json",
                success: function(data) {
                    var questionCard = `
                        <div class="card question-card mt-3 shadow">
                            <div class="card-body">
                                <h5>Domanda:</h5>
                                <p>${data.question}</p>
                            </div>
                        </div>
                        <!-- Clear floats -->
                        <div class="clearfix"></div>`;
                    
                    var answerCard = `
                        <div class="card answer-card mt-3 shadow bg-answer">
                            <div class="card-body">
                                <h5>Risposta:</h5>
                                <p>${data.answer}</p>
                            </div>
                        </div>
                        <!-- Clear floats -->
                        <div class="clearfix"></div>`;
                    
                    // Append new question and answer to the conversation
                    $(questionCard).insertBefore(".card:last");
                    $(answerCard).insertBefore(".card:last");
                    
                    // Clear the input field
                    $('input[name="question"]').val('');

                    // Focus the input field
                    $('input[name="question"]').focus();
                    
                    // Disabling the submit button after the response
                    var submitButton = document.querySelector('.submit-button');
                    submitButton.classList.remove('active');
                    submitButton.disabled = true;

                    // Scroll to the bottom of the page
                    setTimeout(function() {
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast');
                    }, 100);
                }
            });
        });
    });
</script>
{% endblock %}
